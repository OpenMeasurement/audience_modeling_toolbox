Mathematical framework of VID modeling
======================================

This page is meant to familiarize and sets the stage the theory of reach-frequency surfaces using the concept of the activity distribution function. This will then be used by any virtual society modeling mechanism to genenrate virtual members with a given activity.

For simplicity of notation and to make it easier to follow we first illustrate the concept of the activity distribution function and the relations to reach-frequency surfaces using a single medium and then generalized the ideas to multidimensional media treatments.

The activity distribution function (ADF)
----------------------------------------

Imagine for each user :math:`u \in U`, with the total number of users :math:`N=|U|`.  We have the probability of :math:`q_u` to receive an impression, or generate an event. Note that :math:`q_u` can also be interpreted as the rate of impression generation of user :math:`u`. Throughout this section, we assume that the probability is specific to each user and remains constant during the experiment. Since each event should ultimately correspond to a person then across the universe :math:`\sum_{u\in U} q_u = 1`. Given the total number of impressions, :math:`I`, the probability of receiving at least one impression, that is the frequency of exposure for a user :math:`u` to be at least one, :math:`f_u \geq 1`, is given by

.. math::
   \operatorname{P}(f_u \geq 1) = 1 - (1 - q_u)^ I \approx 1 - \mathrm{e}^{-q_u I}

where we assumed that :math:`q_u \ll 1` for all users, which is a very reasonable assumption considering the numbers of users in out universe and their actual behavior. Let's define the rate of generating views (or cookies) for each person by :math:`x_u = Nq_u`. Therefore, :math:`x_u` is the number of impressions generated by user :math:`u` if :math:`N` impressions are dispersed to the universe, i.e. an average of a single impression per person is dispersed.

Let us also define the *gross rating* with :math:`g=I/N`, that is the number impressions generated per person. This means the expected number of impressions generated by user :math:`u` is given by :math:`q_uI = x_ug`

We can now calculate the expected *reach per viewer*, :math:`\rho`, as a function of gross rating :math:`g`,

.. math::
   :nowrap:

   \begin{align}
      \rho(g) \equiv \frac{\langle R_{1+} (I) \rangle}{N}
      & = \frac{1}{N} \sum_{u \in U} \operatorname{P}(f_u \geq 1) \nonumber \\
      & = \frac{1}{N}\sum_{u \in U} (1 - \mathrm{e}^{-x_ug})
   \end{align}

We can go from a summation over users to an integration over the space of impression (cookie) generation rates by

.. math::
   \frac{1}{N}\sum_{u\in U} ~\longrightarrow~ \int \mathrm{d}\mu = \int_0^N \mathcal{A}(x) \mathrm{d}x
   :label: continuum

where :math:`\mathrm{d}\mu = \mathcal{A}(x)\mathrm{d}x` is the integration measure over the rate space. Therefore, :math:`\mathcal{A}(x)` can be interpreted as the probability distribution function of impression generation rates for users, or \emph{activity distribution function} (ADF) [Koehler2016]_ , [Skvortsov2019]_ . Therefore, we find the following relation between the expected :math:`1+` reach per person and ADF.

.. math::
   :label: eq:reach-adf-relation

   \rho(g) = \int_0^N(1 - \mathrm{e}^{-gx}) ~\mathcal{A}(x) ~\mathrm{d}x

Extending the domain of integration to infinity (by setting :math:`\mathcal{A}(x)` to zero for any value larger than :math:`N`), the :math:`\mathcal{A}(x)` has to satisfy the following normalization conditions

.. math::
   :nowrap:

   \begin{align}
      \frac{1}{N}\sum_{u\in U} 1 = 1 \quad & \implies \quad \int_0^\infty \mathcal{A}(x) ~\mathrm{d}x = 1 \\
      \frac{1}{N}\sum_{u\in U} q_u N = 1 \quad & \implies \quad \int_0^\infty x\mathcal{A}(x) ~\mathrm{d}x = 1
   \end{align}

were the first constraint is the normalization of ADF to be a probability distribution function over people and second constraint enforces that every impressions has to always connect to a user. We emphasize that we can relax the second constraint and allow for some impressions to go unassigned. If the constraint is approximately less than 1 this should not have a significant effect on the error.

We can find the ADF from a reach curve

.. math::
   \mathcal{A}(x) = \mathcal{L}^{-1}[1 - \rho(g)]

where :math:`\mathcal{L}^{-1}[\cdot ]` stands for the inverse Laplace transform, and Laplace transform :math:`\mathcal{L}[\cdot ]` is defined as usual

.. math::
   F(s) = \mathcal{L}[f(x)](s) = \int_0^{\infty} \mathrm{e}^{-sx}f(x) ~ \mathrm{d}x.


:math:`n`--Reach/Frequency curve
--------------------------------

For the :math:`n`--reach/frequency curve we follow a similar argument using the activity distribution function. The (normalized) number of people reached exactly :math:`m` times is

.. math::
   :nowrap:

   \begin{align}
      r_m(I)
      & = \frac{1}{N}\sum_{u\in U} \mathrm{P}(f_u = m) \\
      & = \frac{1}{N}\sum_{u\in U} \binom{I}{m} \left( \frac{x_u}{N}\right)^{m} \left( 1 - \frac{x_u}{N}\right)^{I-m}
   \end{align}

again using the argument that the probability of receiving an impression :math:`x_u/N` is small and going to the continuum limit using equation :eq:`continuum` , and the Stirling approximation of the factorial, we can write This is also assuming :math:`I \gg m` right

.. math::
   r_m(g) \approx \int_0^{\infty} \frac{(gx)^m}{m!}\mathrm{e}^{-gx}~ \mathcal{A}(x)\mathrm{d}x.

And for the :math:`n+`--reach we have (careful about the approx here, and normalization of :math:`\mathcal{A}`)

.. math::
   r_{m+}(g) \approx \int_0^{\infty}\left( 1-\frac{\Gamma(m, gx)}{\Gamma (m)}\right)~ \mathcal{A}(x)\mathrm{d}x.



The virtual society
-------------------

The initial step of the virtual ID assignment is to create a virtual society, shown by the set :math:`V`, which can be the set of nonzero integers :math:`\leq N`. Every member of the society could also be equipped with a set of personal information depending on the nature of report , as well as a desi-gnated impression generation rates. The personal info may include Geo-location, demographics, and interests. The virtual society is built in such a way that if the impressions are to be randomly assigned to the member of the society according to their generation rate, then the virtual ID reach and frequency of the ad campaign mimics the real reach and frequency of the ad campaign for the real society.

In the case of mixture of deltas, we assign a range of VIDs to each bucket of people rates. These buckets could be made in a space of demographics or better in a label space with a probability distribution over the demographics, or interests. This kind of virtual society is first part of VID assignment suggested in Ref. `Skvortsov2019`_


References
----------

.. [Koehler2016] google_cross_device
.. `Skvortsov2019`:  google_virtual_people
